#!/usr/bin/lua

local uci = require('simple-uci').cursor()
local enabled = uci:get_first('tunneldigger', 'broker', 'enabled')
io.popen('logger -t tunneldiger-watchdog "runned"')
if enabled then
        local handleBatctl = io.popen("batctl o |grep mesh-vpn |wc -l")
        local resultBatctl = handleBatctl:read("*l")
        handleBatctl:close()

        local handleProcessGrep = io.popen("pgrep tunneldigger | head -n 1")
        local resultProcessGrep = handleProcessGrep:read("*l")
        handleProcessGrep:close()
        io.popen('logger -t tunneldiger-watchdog "Batctl:#'.. resultBatctl ..'#"')
        io.popen('logger -t tunneldiger-watchdog "ProcessGrep'.. resultProcessGrep ..'"')
        local f = io.open("/var/run/tunneldigger.mesh-vpn.pid", "r")
        if f==nil then
                io.popen('logger -t tunneldiger-watchdog "PID-Datei existiert nicht"')
                restartTunneldigger()
                return
        end
        local tunneldiggerPidFile = f:read "*l"
        f:close()
        if not resultProcessGrep == tunneldiggerPidFile then
                io.popen('logger -t tunneldiger-watchdog "PID-Komisch"')
                restartTunneldigger()
                return
        end
        if resultBatctl == "0" then
                io.popen('logger -t tunneldiger-watchdog "Keine Mesh nachbarn"')
                restartTunneldigger()
                return
        end
end


function restartTunneldigger()
        io.popen('/etc/init.d/tunneldigger stop')
        sleep(1)
        io.popen('killall -KILL tunneldigger')
        io.popen('rm -f /var/run/tunneldigger.mesh-vpn.pid')
        sleep(5)
        io.popen('/etc/init.d/tunneldigger start')
        io.popen('logger -t tunneldigger-watchdog "Tunneldigger deamon or mesh neigbours not found. Try to start it again."')
end

function sleep(s)
  local ntime = os.time() + s
  repeat until os.time() > ntime
end

