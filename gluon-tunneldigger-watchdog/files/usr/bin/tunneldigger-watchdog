#!/usr/bin/lua

function restartTunneldigger()
	io.popen('logger -t tunneldigger-watchdog "Try to restart Tunneldigger."')
	os.execute("/etc/init.d/tunneldigger restart")
end

function readPidFile()
	local pidFile = io.open("/var/run/tunneldigger.mesh-vpn.pid", "r")
	local returnPid = "0"
	if pidFile~=nil then 
		returnPid = pidFile:read("*l") 
		io.close(pidFile)
	end
	return returnPid
end

function getNeighbourCount()
        local list = io.lines("/sys/kernel/debug/batman_adv/bat0/originators")
        local returnNeighbours = 0
        if list~=nil then
                for line in list do
                        if string.find(line,"[  mesh-vpn]:") then
                                returnNeighbours=returnNeighbours+1
                        end
                end
        end
        print(returnNeighbours)
        return returnNeighbours
end

local uci = require('simple-uci').cursor()
local enabled = uci:get_bool('tunneldigger', 'mesh_vpn', 'enabled') 
if enabled then
	if io.popen("pgrep tunneldigger"):read("*l") ~= readPidFile() then
		io.popen('logger -t tunneldigger-watchdog "Process-Pid doesn`t match with pid-File."')
		restartTunneldigger()
		return
	end
        if getNeighbourCount() == 0 then
		io.popen('logger -t tunneldigger-watchdog "No mesh neighbours."')
		restartTunneldigger()
		return
        end
end
